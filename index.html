<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>糖質・インスリン計算ツール</title>

<style>
  body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
  h1 { font-size: 24px; }
  h2 { margin-top: 30px; font-size: 20px; }
  label { display: block; margin-top: 10px; }
  input, select { padding: 8px; width: 100%; font-size: 16px; }
  button {
    margin-top: 15px; padding: 12px; width: 100%;
    background: #007bff; color: white; border: none; font-size: 18px;
    border-radius: 6px;
  }
  .box {
    border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 8px;
  }
  #historyTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
  #historyTable th, #historyTable td {
    border: 1px solid #ddd; padding: 6px; text-align: center; font-size: 14px;
  }
  #historyTable th { background: #f0f0f0; }

  /* 記録表 */
  #recordTable { width: 1400px; border-collapse: collapse; }
  #recordWrapper { overflow-x: auto; }

  #recordTable th, #recordTable td {
    border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 14px;
  }
  #recordTable th { background: #f8f8f8; }

  @media (max-width: 600px) {
    body { padding: 10px; }
    h1 { font-size: 20px; }
  }
</style>
</head>

<body>
<h1>糖質・インスリン計算ツール</h1>

<!-- ------------------ ① 計算エリア ------------------ -->
<div class="box">
<h2>① インスリン計算</h2>

<label>日付：</label>
<input type="date" id="calcDate">

<label>食事時間：</label>
<select id="mealTime">
  <option value="morning">朝</option>
  <option value="noon">昼</option>
  <option value="evening">夜</option>
  <option value="other">その他</option>
</select>

<label>インスリン1Uで変化する血糖値（mg/dL）</label>
<input type="number" id="insulinChange">

<label>主食の種類：</label>
<select id="mainFood" onchange="toggleMainFoodMode()">
  <option value="rice">お米</option>
  <option value="bread">パン</option>
  <option value="noodle">麺</option>
</select>

<label>主食の量（g）：</label>
<input type="number" id="mainGram">

<label>主食の糖質量（g）：</label>
<input type="number" id="mainCarb">

<label>その他の食べ物（複数可）：</label>
<input type="text" id="otherFood" placeholder="例：りんご、バナナ">

<label>その他の糖質量（g）：</label>
<input type="number" id="otherCarb">

<label>カーボ比（g/1U）：</label>
<input type="number" id="carbRatio">

<label>現在血糖値（mg/dL）：</label>
<input type="number" id="currentBg">

<label>目標血糖値（mg/dL）：</label>
<input type="number" id="targetBg">

<button onclick="calculateInsulin()">インスリン計算</button>

<div id="result" style="margin-top:15px; font-size:18px;"></div>

<h3>計算履歴（最新3件）</h3>
<table id="historyTable">
  <thead>
    <tr>
      <th>日付</th><th>時間</th><th>主食</th><th>糖質(g)</th><th>Ins(U)</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<button onclick="reflectToTable()">→ この計算結果を記録表へ反映</button>

</div>

<!-- ------------------ ② 記録表 ------------------ -->
<h2>② 血糖値 & インスリン記録表</h2>

<label>年：</label>
<select id="yearSelect" onchange="drawRecordTable()">
  <option>2025</option>
  <option>2026</option>
  <option>2027</option>
</select>

<label>月：</label>
<select id="monthSelect" onchange="drawRecordTable()">
  <!-- 1〜12 を生成 -->
  <script>
    for(let i=1;i<=12;i++){
      document.write(`<option value="${i}">${i}</option>`);
    }
  </script>
</select>

<div id="recordWrapper">
  <table id="recordTable"></table>
</div>

<script>
/* ---------------------------------
   ローカル保存データ
-----------------------------------*/
let history = JSON.parse(localStorage.getItem("history") || "[]");
let records = JSON.parse(localStorage.getItem("records") || "{}");

/* ---------------------------------
   ① 主食入力切替
-----------------------------------*/
function toggleMainFoodMode(){
  // 何もしない（将来拡張用）
}

/* ---------------------------------
   ① 計算処理
-----------------------------------*/
function calculateInsulin(){
  const date = document.getElementById("calcDate").value;
  const meal = document.getElementById("mealTime").value;

  const insulinChange = Number(document.getElementById("insulinChange").value);

  const mainFood = document.getElementById("mainFood").value;
  const mainGram = Number(document.getElementById("mainGram").value);
  const mainCarbInput = Number(document.getElementById("mainCarb").value);

  const otherCarb = Number(document.getElementById("otherCarb").value);

  const carbRatio = Number(document.getElementById("carbRatio").value);
  const currentBg = Number(document.getElementById("currentBg").value);
  const targetBg = Number(document.getElementById("targetBg").value);

  // 主食糖質量の計算（優先順位：主食糖質 ＞ 主食量）
  const carbTable = { rice:37, bread:44, noodle:25 };
  let mainCarb = mainCarbInput ? mainCarbInput : mainGram * carbTable[mainFood] / 100;

  const totalCarb = mainCarb + otherCarb;

  const insulinCarb = totalCarb / carbRatio;
  const insulinCorr = (currentBg - targetBg) / insulinChange;
  const insulin = Math.max(0, insulinCarb + insulinCorr);

  document.getElementById("result").innerHTML =
    `合計糖質：${totalCarb.toFixed(1)} g<br>
     インスリン必要量：<b>${insulin.toFixed(1)} U</b>`;

  // 履歴保存（3件まで）
  const entry = {
    date, meal, mainFood,
    carb: totalCarb.toFixed(1),
    insulin: insulin.toFixed(1)
  };

  history.unshift(entry);
  if(history.length > 3) history.pop();
  localStorage.setItem("history", JSON.stringify(history));
  renderHistory();
}

/* ---------------------------------
   履歴表示
-----------------------------------*/
function renderHistory(){
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";
  history.forEach(h=>{
    tbody.innerHTML += `
      <tr>
        <td>${h.date}</td>
        <td>${convertMealLabel(h.meal)}</td>
        <td>${h.mainFood}</td>
        <td>${h.carb}</td>
        <td>${h.insulin}</td>
      </tr>`;
  });
}

function convertMealLabel(m){
  return {morning:"朝", noon:"昼", evening:"夜", other:"その他"}[m];
}

/* ---------------------------------
   表に反映
-----------------------------------*/
function reflectToTable(){
  if(history.length === 0){
    alert("計算履歴がありません");
    return;
  }

  const latest = history[0];

  const key = `${latest.date}`;
  if(!records[key]) records[key] = {
    morning:{bg:"",ins:""},
    noon:{bg:"",ins:""},
    evening:{bg:"",ins:""},
    other:{bg:"",ins:""},
    memo:""
  };

  records[key][latest.meal].bg = ""; // BG は計算にないため空欄
  records[key][latest.meal].ins = latest.insulin;

  localStorage.setItem("records", JSON.stringify(records));

  drawRecordTable();
  alert("反映しました");
}

/* ---------------------------------
   ② 記録表の生成
-----------------------------------*/
function drawRecordTable(){
  const year = document.getElementById("yearSelect").value;
  const month = Number(document.getElementById("monthSelect").value);

  const days = new Date(year, month, 0).getDate();

  let html = "<tr><th>日</th><th>朝 BG</th><th>朝Ins</th><th>昼 BG</th><th>昼Ins</th><th>夜 BG</th><th>夜Ins</th><th>その他 BG</th><th>その他Ins</th><th>メモ</th></tr>";

  for(let d=1; d<=days; d++){
    const dateKey = `${year}-${String(month).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if(!records[dateKey]){
      records[dateKey] = {
        morning:{bg:"",ins:""},
        noon:{bg:"",ins:""},
        evening:{bg:"",ins:""},
        other:{bg:"",ins:""},
        memo:""
      };
    }

    const r = records[dateKey];
    html += `
      <tr>
        <td>${d}</td>
        <td contenteditable onblur="updateRecord('${dateKey}','morning','bg',this.innerText)">${r.morning.bg}</td>
        <td contenteditable onblur="updateRecord('${dateKey}','morning','ins',this.innerText)">${r.morning.ins}</td>

        <td contenteditable onblur="updateRecord('${dateKey}','noon','bg',this.innerText)">${r.noon.bg}</td>
        <td contenteditable onblur="updateRecord('${dateKey}','noon','ins',this.innerText)">${r.noon.ins}</td>

        <td contenteditable onblur="updateRecord('${dateKey}','evening','bg',this.innerText)">${r.evening.bg}</td>
        <td contenteditable onblur="updateRecord('${dateKey}','evening','ins',this.innerText)">${r.evening.ins}</td>

        <td contenteditable onblur="updateRecord('${dateKey}','other','bg',this.innerText)">${r.other.bg}</td>
        <td contenteditable onblur="updateRecord('${dateKey}','other','ins',this.innerText)">${r.other.ins}</td>

        <td contenteditable onblur="updateRecordMemo('${dateKey}',this.innerText)">${r.memo}</td>
      </tr>
    `;
  }

  document.getElementById("recordTable").innerHTML = html;
  localStorage.setItem("records", JSON.stringify(records));
}

/* ---------------------------------
   表セル編集保存
-----------------------------------*/
function updateRecord(date, meal, type, value){
  records[date][meal][type] = value;
  localStorage.setItem("records", JSON.stringify(records));
}

function updateRecordMemo(date, value){
  records[date].memo = value;
  localStorage.setItem("records", JSON.stringify(records));
}

/* 初期表示 */
renderHistory();
drawRecordTable();
</script>

</body>
</html>


