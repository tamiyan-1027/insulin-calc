<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>糖質・インスリン計算＆記録ツール</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
  h1 { font-size: 24px; }
  label { display: block; margin-top: 10px; font-size: 16px; }
  input, select { padding: 7px; width: 100%; font-size: 16px; }
  button { margin-top: 20px; padding: 12px; font-size: 18px; border-radius: 6px; cursor: pointer; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  td, th { border: 1px solid #ccc; text-align: center; padding: 6px; }
  th { background-color: #f4f4f4; }
</style>
</head>
<body>

<h1>糖質・インスリン計算＆記録ツール</h1>

<div>
  <h2>① インスリン計算</h2>
  <label>日付：</label><input type="date" id="dateSelector">
  <label>食事時間：</label>
  <select id="mealTime">
    <option value="morning">朝</option>
    <option value="afternoon">昼</option>
    <option value="evening">夜</option>
    <option value="other">その他</option>
  </select>
  <label>インスリン1Uで変化する血糖値（mg/dL）：</label>
  <input type="number" id="insulinChange">
  <label>主食：</label>
  <select id="mainFood" onchange="toggleCarbInput()">
    <option value="rice">お米</option>
    <option value="bread">パン</option>
    <option value="noodle">麺</option>
  </select>
  <label>主食量(g) または 糖質量(g)：</label>
  <input type="number" id="mainGram" placeholder="主食量" />
  <input type="number" id="otherCarbs" placeholder="その他糖質量" />
  <label>その他の食べ物：</label>
  <input type="text" id="otherFood" placeholder="例：リンゴ、バナナ">
  <label>カーボ比 (g / 1U)：</label>
  <input type="number" id="carbRatio">
  <label>現在血糖値：</label>
  <input type="number" id="currentBg">
  <label>目標血糖値：</label>
  <input type="number" id="targetBg">
  <button onclick="calculateInsulin()">計算して履歴に追加</button>
  <div id="result"></div>
</div>

<h2>② 記録表（血糖値・インスリン）</h2>
<label>年：</label>
<select id="yearSelector"></select>
<label>月：</label>
<select id="monthSelector"></select>
<button onclick="generatePDF()">PDF出力</button>

<table id="recordTable">
  <thead>
    <tr>
      <th>日付</th>
      <th>朝 BG</th><th>朝 Ins</th>
      <th>昼 BG</th><th>昼 Ins</th>
      <th>夜 BG</th><th>夜 Ins</th>
      <th>その他 BG</th><th>その他 Ins</th>
      <th>メモ</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const mealLabelMap = { morning:'朝', afternoon:'昼', evening:'夜', other:'その他' };
const carbTable = { rice:37, bread:44, noodle:25 };

let history = JSON.parse(localStorage.getItem('history')) || [];
let lastInsulinChange = { morning:'', afternoon:'', evening:'', other:'' };
let lastCarbRatio = { morning:12, afternoon:12, evening:12, other:12 };
let lastTargetBg = 100;

function toggleCarbInput(){}

function calculateInsulin(){
  const date = document.getElementById('dateSelector').value;
  const mealTime = document.getElementById('mealTime').value;
  const insulinChange = Number(document.getElementById('insulinChange').value);
  const mainFood = document.getElementById('mainFood').value;
  const mainGram = Number(document.getElementById('mainGram').value);
  const otherCarbs = Number(document.getElementById('otherCarbs').value)||0;
  const carbRatio = Number(document.getElementById('carbRatio').value);
  const currentBg = Number(document.getElementById('currentBg').value);
  const targetBg = Number(document.getElementById('targetBg').value);
  const otherFood = document.getElementById('otherFood').value;

  lastInsulinChange[mealTime]=insulinChange;
  lastCarbRatio[mealTime]=carbRatio;
  lastTargetBg=targetBg;

  const mainCarbs = mainGram*(carbTable[mainFood]/100);
  const totalCarbs = mainCarbs + otherCarbs;
  const carbInsulin = totalCarbs / carbRatio;
  const correctionInsulin = (currentBg - targetBg)/insulinChange;
  const totalInsulin = Math.max(carbInsulin + correctionInsulin,0);

  document.getElementById('result').innerHTML =
    `合計糖質: ${totalCarbs.toFixed(1)}g, 必要インスリン: ${totalInsulin.toFixed(1)}U`;

  const entry = { date, meal:mealTime, bg:currentBg, insulin:totalInsulin.toFixed(1), otherFood };
  history.unshift(entry);
  if(history.length>3) history.pop();
  localStorage.setItem('history', JSON.stringify(history));
  updateRecordTable();
}

function updateRecordTable(){
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML='';
  const year = Number(document.getElementById('yearSelector').value);
  const month = Number(document.getElementById('monthSelector').value);

  const daysInMonth = new Date(year, month, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d}</td>`+
      `<td contenteditable></td><td contenteditable></td>`+ // 朝
      `<td contenteditable></td><td contenteditable></td>`+ // 昼
      `<td contenteditable></td><td contenteditable></td>`+ // 夜
      `<td contenteditable></td><td contenteditable></td>`+ // その他
      `<td contenteditable></td>`; // メモ
    tbody.appendChild(tr);
  }

  // 直近履歴を表に反映
  history.forEach(entry=>{
    const entryDate = new Date(entry.date);
    if(entryDate.getFullYear()===year && (entryDate.getMonth()+1)===month){
      const tr = tbody[entryDate.getDate()-1];
      switch(entry.meal){
        case 'morning': tr.children[1].textContent=entry.bg; tr.children[2].textContent=entry.insulin; break;
        case 'afternoon': tr.children[3].textContent=entry.bg; tr.children[4].textContent=entry.insulin; break;
        case 'evening': tr.children[5].textContent=entry.bg; tr.children[6].textContent=entry.insulin; break;
        case 'other': tr.children[7].textContent=entry.bg; tr.children[8].textContent=entry.insulin; break;
      }
    }
  });
}

// 年・月の初期化
const yearSel = document.getElementById('yearSelector');
const monthSel = document.getElementById('monthSelector');
const now = new Date();
for(let y=2025;y<=2027;y++){
  const opt = document.createElement('option'); opt.value=y; opt.text=y; yearSel.appendChild(opt);
}
yearSel.value=now.getFullYear();
for(let m=1;m<=12;m++){
  const opt = document.createElement('option'); opt.value=m; opt.text=m; monthSel.appendChild(opt);
}
monthSel.value=now.getMonth()+1;

yearSel.onchange=updateRecordTable;
monthSel.onchange=updateRecordTable;

updateRecordTable();

// PDF出力
function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','pt','a4');
  doc.setFontSize(12);
  doc.text(`血糖値・インスリン記録表 ${yearSel.value}年 ${monthSel.value}月`, 40, 30);

  const table = document.getElementById('recordTable');
  const rows = table.querySelectorAll('tr');
  const colWidths = [40,40,40,40,40,40,40,40,40,80];
  let startY=50;

  rows.forEach((row,rowIdx)=>{
    let startX=40;
    const cells = row.querySelectorAll('th, td');
    cells.forEach((cell,cellIdx)=>{
      doc.rect(startX,startY,colWidths[cellIdx],20);
      doc.text(cell.textContent||'', startX+2, startY+14);
      startX+=colWidths[cellIdx];
    });
    startY+=20;
    if(startY>550){doc.addPage(); startY=50;}
  });

  doc.save(`BG_Insulin_${yearSel.value}_${monthSel.value}.pdf`);
}
</script>
</body>
</html>




