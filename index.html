<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>糖質・インスリン計算ツール（個人用）</title>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { padding: 7px; width: 100%; font-size: 16px; }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      font-size: 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
    }
    .box {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 6px;
    }
    #historyList table {
      width: 100%;
      border-collapse: collapse;
    }
    #historyList td, th {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #historyList th {
      background-color: #f4f4f4;
    }
    .history-row {
      font-size: 14px;
    }
    #historyList {
      overflow-x: auto;
    }

    /* スマホ向けデザイン */
    @media (max-width: 600px) {
      body { padding: 10px; font-size: 14px; }
      input, select { width: 100%; font-size: 18px; }
      button { width: 100%; font-size: 18px; }
      .box { padding: 10px; }
      #historyList table { font-size: 12px; }
    }
  </style>

</head>
<body>

<h1>糖質・インスリン計算ツール（個人用）</h1>

<!-- 主食入力 -->
<div class="box">
  <h2>① インスリン計算</h2>

  <label>食事時間：</label>
  <select id="mealTime">
    <option value="morning">朝</option>
    <option value="afternoon">昼</option>
    <option value="evening">夜</option>
  </select>

  <label>インスリン1単位で変化する血糖値（mg/dL）：</label>
  <input id="insulinChange" type="number" placeholder="例：30" />

  <label>主食の種類：</label>
  <select id="mainFood">
    <option value="rice">お米</option>
    <option value="bread">パン</option>
    <option value="noodle">麺類</option>
  </select>

  <label>食べた量（g）：</label>
  <input id="mainGram" type="number" placeholder="例：150" />

  <label>その他の糖質量（g）：</label>
  <input id="otherCarbs" type="number" placeholder="食べた量から自分で計算して入力" />

  <label>カーボ比（g / 1U）：</label>
  <input id="carbRatio" type="number" />

  <label>現在血糖値（mg/dL）：</label>
  <input id="currentBg" type="number" />

  <label>目標血糖値（mg/dL）：</label>
  <input id="targetBg" type="number" />

  <button onclick="calculateInsulin()">インスリン量を計算する</button>
</div>

<h2>履歴</h2>
<div id="historyList">
  <table>
    <thead>
      <tr>
        <th>日時</th>
        <th>食事時間</th>
        <th>主食</th>
        <th>その他糖質量（g）</th>
        <th>合計糖質量（g）</th>
        <th>必要インスリン量（U）</th>
      </tr>
    </thead>
    <tbody id="historyTable">
      <!-- 履歴がここに表示される -->
    </tbody>
  </table>
</div>

<h2>③ 血糖値・インスリン量グラフ</h2>
<canvas id="insulinChart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 食事時間のラベルマップ
const mealLabelMap = {
  morning: '朝',
  afternoon: '昼',
  evening: '夜'
};

// 主食ごとの糖質量（100gあたりの目安）
const carbTable = {
  rice: 37,
  bread: 44,
  noodle: 25
};

// 履歴データの保存
let history = JSON.parse(localStorage.getItem('history')) || [];

// インスリン量計算
function calculateInsulin() {
  const mealTime = document.getElementById('mealTime').value;
  const insulinChange = Number(document.getElementById('insulinChange').value);
  const mainFood = document.getElementById('mainFood').value;
  const gram = Number(document.getElementById('mainGram').value);
  const otherCarbs = Number(document.getElementById('otherCarbs').value) || 0;
  const carbRatio = Number(document.getElementById('carbRatio').value);
  const currentBg = Number(document.getElementById('currentBg').value);
  const targetBg = Number(document.getElementById('targetBg').value);

  const mainCarbs = gram * (carbTable[mainFood] / 100);
  const totalCarbs = mainCarbs + otherCarbs;

  const carbInsulin = totalCarbs / carbRatio;
  const correctionInsulin = (currentBg - targetBg) / insulinChange;

  const totalInsulin = Math.max(carbInsulin + correctionInsulin, 0);

  // 結果を表示
  document.getElementById('result').innerHTML =
    `■ 主食の糖質：${mainCarbs.toFixed(1)} g<br>■ その他の糖質：${otherCarbs.toFixed(1)} g<br>■ 合計糖質：${totalCarbs.toFixed(1)} g<br><br>必要インスリン量：${totalInsulin.toFixed(2)} U`;

  // 履歴に保存
  saveHistory({
    date: new Date().toLocaleString(),
    meal: mealTime,
    mainFood: mealLabelMap[mealTime],
    otherCarbs: otherCarbs.toFixed(1),
    totalCarbs: totalCarbs.toFixed(1),
    insulin: totalInsulin.toFixed(2),
    bg: currentBg.toFixed(1)
  });

  displayHistory();
}

// 履歴を保存
function saveHistory(data) {
  history.push(data);
  localStorage.setItem('history', JSON.stringify(history));
}

// 履歴を表示
function displayHistory() {
  const tableBody = document.getElementById('historyTable');
  tableBody.innerHTML = '';

  history.forEach(entry => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${entry.date}</td>
      <td>${entry.meal}</td>
      <td>${entry.mainFood}</td>
      <td>${entry.otherCarbs}</td>
      <td>${entry.totalCarbs}</td>
      <td>${entry.insulin}</td>
    `;
    tableBody.appendChild(row);
  });

  // グラフに反映
  updateGraph();
}

// グラフの更新
let insulinChart;

function updateGraph() {
  const labels = history.map(item => `${item.date} ${mealLabelMap[item.meal]}`);
  const bgValues = history.map(item => Number(item.bg));
  const insulinValues = history.map(item => Number(item.insulin));

  if (!insulinChart) {
    const ctx = document.getElementById('insulinChart').getContext('2d');
    insulinChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '血糖値 (mg/dL)',
            data: bgValues,
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1,
            fill: false
          },
          {
            label: 'インスリン量 (U)',
            data: insulinValues,
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            fill: false
          }
        ]
      },
      options: {
        scales: {
          y: {
            min: 50,
            max: 200,
            ticks: {
              stepSize: 25
            }
          },
          y2: {
            min: 0,
            max: 40,
            position: 'right'
          }
        }
      }
    });
  } else {
    insulinChart.data.labels = labels;
    insulinChart.data.datasets[0].data = bgValues;
    insulinChart.data.datasets[1].data = insulinValues;
    insulinChart.update();
  }
}

// 初期表示
displayHistory();
</script>

</body>
</html>

