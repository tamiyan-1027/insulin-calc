<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>糖質・インスリン計算ツール</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
  h1 { font-size: 24px; }
  label { display: block; margin-top: 10px; font-size: 16px; }
  input, select { padding: 7px; width: 100%; font-size: 16px; margin-top: 3px; }
  button { margin-top: 15px; padding: 10px; font-size: 16px; border-radius: 5px; background-color:#007bff; color:white; border:none; cursor:pointer; }
  button:hover { background-color:#0056b3; }
  .box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 8px; }
  #result { margin-top: 10px; font-size: 16px; padding: 10px; background: #f0f8ff; border-radius: 5px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
  th { background-color: #f4f4f4; }
  input[type="number"] { width: 80px; }
  .scroll-container { overflow-x:auto; }
</style>
</head>
<body>

<h1>糖質・インスリン計算ツール</h1>

<div class="box">
  <h2>① インスリン計算</h2>
  <label>日付を選択</label>
  <input type="date" id="dateSelector">
  <label>食事時間</label>
  <select id="mealTime" onchange="loadLastValues()">
    <option value="morning">朝</option>
    <option value="afternoon">昼</option>
    <option value="evening">夜</option>
    <option value="other">その他</option>
  </select>
  <label>インスリン1単位で変化する血糖値(mg/dL)</label>
  <input type="number" id="insulinChange">
  <label>主食の種類</label>
  <select id="mainFood" onchange="toggleCarbInput()">
    <option value="rice">お米</option>
    <option value="bread">パン</option>
    <option value="noodle">麺類</option>
  </select>
  <label id="mainGramLabel">主食量(g)</label>
  <input type="number" id="mainGram">
  <label id="otherCarbsLabel">主食の糖質量(g)</label>
  <input type="number" id="otherCarbs">
  <label>その他の食べ物（名前）</label>
  <input type="text" id="otherFoodName" placeholder="例：リンゴ、バナナ">
  <label>その他の糖質量(g)</label>
  <input type="number" id="otherFoodCarbs" placeholder="例：40">
  <label>カーボ比(g/1U)</label>
  <input type="number" id="carbRatio">
  <label>現在血糖値(mg/dL)</label>
  <input type="number" id="currentBg">
  <label>目標血糖値(mg/dL)</label>
  <input type="number" id="targetBg">
  <button onclick="calculateInsulin()">インスリン量を計算</button>
  <div id="result"></div>
</div>

<h2>計算履歴（最新3件）</h2>
<div class="scroll-container">
  <table id="historyTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Meal</th>
        <th>MainFood</th>
        <th>TotalCarbs(g)</th>
        <th>Insulin(U)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<button onclick="reflectToRecord()">表に反映</button>

<h2>② 血糖値 & インスリン記録表</h2>
<div class="box">
  <label>年</label>
  <select id="yearSelector"></select>
  <label>月</label>
  <select id="monthSelector"></select>

  <div class="scroll-container" id="recordContainer">
    <table id="recordTable">
      <thead>
        <tr>
          <th>Date</th>
          <th colspan="2">Morning</th>
          <th colspan="2">Afternoon</th>
          <th colspan="2">Evening</th>
          <th colspan="2">Other</th>
          <th>Memo</th>
        </tr>
        <tr>
          <th></th>
          <th>BG</th><th>Ins</th>
          <th>BG</th><th>Ins</th>
          <th>BG</th><th>Ins</th>
          <th>BG</th><th>Ins</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<button onclick="exportRecordPDF()">記録表をPDF化</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const mealKeys = ['morning','afternoon','evening','other'];
const mealLabels = { morning:'Morning', afternoon:'Afternoon', evening:'Evening', other:'Other' };
const carbTable = { rice:37, bread:44, noodle:25 };
let lastInsulinChange = { morning:30, afternoon:30, evening:30, other:30 };
let lastCarbRatio = { morning:12, afternoon:12, evening:12, other:12 };
let lastTargetBg = 100;
let history = JSON.parse(localStorage.getItem('history')) || [];
let records = JSON.parse(localStorage.getItem('records')) || {};

function init() {
  const now = new Date();
  const yearSelect = document.getElementById('yearSelector');
  for(let y=2025;y<=2027;y++){
    const opt = document.createElement('option'); opt.value=y; opt.textContent=y; yearSelect.appendChild(opt);
  }
  yearSelect.value = now.getFullYear();
  const monthSelect = document.getElementById('monthSelector');
  for(let m=1;m<=12;m++){
    const opt = document.createElement('option'); opt.value=m; opt.textContent=m;
    monthSelect.appendChild(opt);
  }
  monthSelect.value = now.getMonth()+1;
  loadLastValues();
  displayHistory();
  generateRecordTable();
}

function toggleCarbInput(){
  const food = document.getElementById('mainFood').value;
  document.getElementById('mainGramLabel').textContent='主食量(g)';
  document.getElementById('otherCarbsLabel').textContent='主食の糖質量(g)';
}

function loadLastValues(){
  const mealTime = document.getElementById('mealTime').value;
  document.getElementById('insulinChange').value = lastInsulinChange[mealTime];
  document.getElementById('carbRatio').value = lastCarbRatio[mealTime];
  document.getElementById('targetBg').value = lastTargetBg;
}

function calculateInsulin(){
  const date = document.getElementById('dateSelector').value;
  const mealTime = document.getElementById('mealTime').value;
  const insulinChange = Number(document.getElementById('insulinChange').value);
  const mainFood = document.getElementById('mainFood').value;
  const mainGram = Number(document.getElementById('mainGram').value);
  const otherCarbs = Number(document.getElementById('otherCarbs').value)||0;
  const otherFoodCarbs = Number(document.getElementById('otherFoodCarbs').value)||0;
  const carbRatio = Number(document.getElementById('carbRatio').value);
  const currentBg = Number(document.getElementById('currentBg').value);
  const targetBg = Number(document.getElementById('targetBg').value);
  lastInsulinChange[mealTime] = insulinChange;
  lastCarbRatio[mealTime] = carbRatio;
  lastTargetBg = targetBg;

  const mainCarbs = mainGram*(carbTable[mainFood]/100);
  const totalCarbs = mainCarbs + otherCarbs + otherFoodCarbs;
  const carbInsulin = totalCarbs / carbRatio;
  const correctionInsulin = (currentBg - targetBg)/insulinChange;
  const totalInsulin = Math.max(carbInsulin+correctionInsulin,0);

  document.getElementById('result').innerHTML = 
    `Total Carbs: ${totalCarbs.toFixed(1)} g<br>Insulin Needed: ${totalInsulin.toFixed(1)} U`;

  const entry = {date, meal:mealTime, mainFood, totalCarbs:totalCarbs.toFixed(1), insulin:totalInsulin.toFixed(1)};
  history.unshift(entry);
  if(history.length>3) history.pop();
  localStorage.setItem('history', JSON.stringify(history));
  displayHistory();
}

function displayHistory(){
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML='';
  history.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${e.date}</td><td>${mealLabels[e.meal]}</td><td>${e.mainFood}</td><td>${e.totalCarbs}</td><td>${e.insulin}</td>`;
    tbody.appendChild(tr);
  });
}

function reflectToRecord(){
  const date = document.getElementById('dateSelector').value;
  if(!date) { alert('日付を選んでください'); return; }
  const mealTime = document.getElementById('mealTime').value;
  const currentBg = Number(document.getElementById('currentBg').value);
  const insulin = Number(document.querySelector('#result').innerHTML.match(/Insulin Needed: ([0-9.]+)/)[1]);
  const year = date.split('-')[0];
  const month = parseInt(date.split('-')[1],10);
  if(!records[year]) records[year]={};
  if(!records[year][month]) records[year][month]={};
  records[year][month][date] = records[year][month][date]||{};
  records[year][month][date][mealTime] = {bg:currentBg, insulin:insulin};
  localStorage.setItem('records', JSON.stringify(records));
  generateRecordTable();
}

function generateRecordTable(){
  const year = document.getElementById('yearSelector').value;
  const month = document.getElementById('monthSelector').value;
  const tbody = document.querySelector('#recordTable tbody');
  tbody.innerHTML='';
  for(let d=1;d<=31;d++){
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${d}</td>`;
    mealKeys.forEach(meal=>{
      const data = records[year]?.[month]?.[`${year}-${month.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`]?.[meal];
      const bgVal = data?data.bg:'';
      const insVal = data?data.insulin:'';
      tr.innerHTML+=`<td><input type="number" value="${bgVal}" onchange="updateRecord('${year}','${month}','${d}','${meal}','bg',this.value)"></td>`;
      tr.innerHTML+=`<td><input type="number" value="${insVal}" onchange="updateRecord('${year}','${month}','${d}','${meal}','insulin',this.value)"></td>`;
    });
    tr.innerHTML+='<td><input type="text"></td>';
    tbody.appendChild(tr);
  }
}

function updateRecord(year,month,day,meal,type,value){
  if(!records[year]) records[year]={};
  if(!records[year][month]) records[year][month]={};
  if(!records[year][month][`${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`])
    records[year][month][`${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`]={};
  if(!records[year][month][`${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`][meal])
    records[year][month][`${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`][meal]={};
  records[year][month][`${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`][meal][type]=Number(value);
  localStorage.setItem('records', JSON.stringify(records));
}

document.getElementById('yearSelector').addEventListener('change', generateRecordTable);
document.getElementById('monthSelector').addEventListener('change', generateRecordTable);

async function exportRecordPDF(){
  const { jsPDF } = window.jspdf;
  const recordContainer = document.getElementById('recordContainer');
  const canvas = await html2canvas(recordContainer, { scale:2 });
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','pt','a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = pdf.internal.pageSize.getHeight();
  const imgProps = { width: canvas.width, height: canvas.height };
  const ratio = Math.min(pdfWidth/imgProps.width, pdfHeight/imgProps.height);
  let heightLeft = canvas.height * ratio;
  let position = 0;

  pdf.addImage(imgData,'PNG',0,position,canvas.width*ratio,canvas.height*ratio);
  heightLeft -= pdfHeight;

  while(heightLeft > 0){
    pdf.addPage();
    position -= pdfHeight;
    pdf.addImage(imgData,'PNG',0,position,canvas.width*ratio,canvas.height*ratio);
    heightLeft -= pdfHeight;
  }

  pdf.save(`Record_${document.getElementById('yearSelector').value}_${document.getElementById('monthSelector').value}.pdf`);
}

init();
</script>

</body>
</html>










